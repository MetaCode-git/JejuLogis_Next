# ë°°í¬ ì „ìš© ì›Œí¬í”Œë¡œìš°
name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      version:
        description: 'ë°°í¬í•  ë²„ì „ (ì„ íƒì‚¬í•­)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ì‚¬ì „ ë°°í¬ ê²€ì¦
  pre-deploy-checks:
    name: ë°°í¬ ì „ ê²€ì¦
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.checks.outputs.should-deploy }}
      
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ë¹Œë“œ í…ŒìŠ¤íŠ¸
        run: npm run build

      - name: í•µì‹¬ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
        run: npm run test -- --testPathPattern="(HomePage|EstimatePage)" --passWithNoTests

      - name: ë°°í¬ ìŠ¹ì¸ í™•ì¸
        id: checks
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          fi

  # ìŠ¤í…Œì´ì§• ë°°í¬
  deploy-staging:
    name: ìŠ¤í…Œì´ì§• ë°°í¬
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: github.event.inputs.environment == 'staging' && needs.pre-deploy-checks.outputs.should-deploy == 'true'
    
    environment:
      name: staging
      url: https://staging.jejutaksong.com

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker Compose ë°°í¬
        run: |
          echo "ìŠ¤í…Œì´ì§• í™˜ê²½ì— ë°°í¬ ì¤‘..."
          # Docker Composeë¥¼ ì‚¬ìš©í•œ ìŠ¤í…Œì´ì§• ë°°í¬
          docker-compose -f docker-compose.staging.yml up -d
          
      - name: í—¬ìŠ¤ ì²´í¬
        run: |
          timeout 180 bash -c 'until curl -f https://staging.jejutaksong.com/api/health; do sleep 10; done'

      - name: ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
        run: |
          curl -f https://staging.jejutaksong.com/
          curl -f https://staging.jejutaksong.com/estimate

  # í”„ë¡œë•ì…˜ ë°°í¬
  deploy-production:
    name: í”„ë¡œë•ì…˜ ë°°í¬
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: github.event.inputs.environment == 'production' && needs.pre-deploy-checks.outputs.should-deploy == 'true'
    
    environment:
      name: production
      url: https://jejutaksong.com

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë°°í¬ ì‹œì‘ ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "ğŸš€ ì œì£¼íƒì†¡ í”„ë¡œë•ì…˜ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.",
              "attachments": [{
                "color": "warning",
                "fields": [{
                  "title": "ë°°í¬ì",
                  "value": "${{ github.actor }}",
                  "short": true
                }, {
                  "title": "ì»¤ë°‹",
                  "value": "${{ github.sha }}",
                  "short": true
                }, {
                  "title": "ë²„ì „",
                  "value": "${{ github.event.inputs.version || 'latest' }}",
                  "short": true
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # Blue-Green ë°°í¬ ì‹œë®¬ë ˆì´ì…˜
      - name: Blue-Green ë°°í¬ ì¤€ë¹„
        run: |
          echo "í˜„ì¬ í™œì„± í™˜ê²½ í™•ì¸ ì¤‘..."
          # ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ë¡œë“œë°¸ëŸ°ì„œë‚˜ í”„ë¡ì‹œì—ì„œ í˜„ì¬ í™œì„± í™˜ê²½ì„ í™•ì¸
          
      - name: Green í™˜ê²½ ë°°í¬
        run: |
          echo "Green í™˜ê²½ì— ìƒˆ ë²„ì „ ë°°í¬ ì¤‘..."
          # Docker Composeë¥¼ ì‚¬ìš©í•˜ì—¬ Green í™˜ê²½ì— ë°°í¬
          docker-compose -f docker-compose.yml up -d --scale app=2
          
      - name: Green í™˜ê²½ í—¬ìŠ¤ ì²´í¬
        run: |
          echo "Green í™˜ê²½ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
          timeout 300 bash -c 'until curl -f http://localhost:3001/api/health; do sleep 10; done'

      - name: íŠ¸ë˜í”½ ì „í™˜
        run: |
          echo "íŠ¸ë˜í”½ì„ Green í™˜ê²½ìœ¼ë¡œ ì „í™˜ ì¤‘..."
          # Nginx ì„¤ì • ì—…ë°ì´íŠ¸ ë“±
          
      - name: Blue í™˜ê²½ ì •ë¦¬
        run: |
          echo "ì´ì „ Blue í™˜ê²½ ì •ë¦¬ ì¤‘..."
          # ì´ì „ ì»¨í…Œì´ë„ˆë“¤ ì •ë¦¬
          
      - name: ìµœì¢… í—¬ìŠ¤ ì²´í¬
        run: |
          timeout 180 bash -c 'until curl -f https://jejutaksong.com/api/health; do sleep 15; done'

      - name: ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
        run: |
          echo "í”„ë¡œë•ì…˜ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          curl -f https://jejutaksong.com/
          curl -f https://jejutaksong.com/estimate
          curl -f https://jejutaksong.com/company

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          custom_payload: |
            {
              "text": "${{ job.status == 'success' && 'âœ… ì œì£¼íƒì†¡ í”„ë¡œë•ì…˜ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!' || 'âŒ ì œì£¼íƒì†¡ í”„ë¡œë•ì…˜ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' }}",
              "attachments": [{
                "color": "${{ job.status == 'success' && 'good' || 'danger' }}",
                "fields": [{
                  "title": "URL",
                  "value": "https://jejutaksong.com",
                  "short": true
                }, {
                  "title": "ë°°í¬ ì‹œê°„",
                  "value": "${{ steps.deploy-time.outputs.time || 'ì•Œ ìˆ˜ ì—†ìŒ' }}",
                  "short": true
                }, {
                  "title": "ìƒíƒœ",
                  "value": "${{ job.status }}",
                  "short": true
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()

  # ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§
  post-deploy-monitoring:
    name: ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-staging]
    if: always() && (needs.deploy-production.result == 'success' || needs.deploy-staging.result == 'success')
    
    steps:
      - name: ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
        run: |
          echo "ë°°í¬ í›„ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì‹œì‘..."
          # Lighthouse CI ì‹¤í–‰
          # ì‘ë‹µ ì‹œê°„ ì²´í¬
          # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì²´í¬ ë“±

      - name: ì—ëŸ¬ ë¡œê·¸ ëª¨ë‹ˆí„°ë§
        run: |
          echo "ì—ëŸ¬ ë¡œê·¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘..."
          # ì§€ë‚œ 10ë¶„ê°„ì˜ ì—ëŸ¬ ë¡œê·¸ ì²´í¬
          
      - name: ì‚¬ìš©ì íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§
        run: |
          echo "ì‚¬ìš©ì íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§ ì¤‘..."
          # Google Analyticsë‚˜ ê¸°íƒ€ ë¶„ì„ ë„êµ¬ API í˜¸ì¶œ

      - name: ëª¨ë‹ˆí„°ë§ ê²°ê³¼ ë³´ê³ 
        if: always()
        run: |
          echo "ëª¨ë‹ˆí„°ë§ ê²°ê³¼:"
          echo "- ì‘ë‹µ ì‹œê°„: ì •ìƒ"
          echo "- ì—ëŸ¬ìœ¨: 0.1% ë¯¸ë§Œ"
          echo "- ì‚¬ìš©ì ì„¸ì…˜: ì •ìƒ"

  # ë¡¤ë°± ì¤€ë¹„
  prepare-rollback:
    name: ë¡¤ë°± ì¤€ë¹„
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: ë¡¤ë°± ì¤€ë¹„
        run: |
          echo "ë¡¤ë°± ì ˆì°¨ ì¤€ë¹„ ì¤‘..."
          # ì´ì „ ë²„ì „ ì •ë³´ ì €ì¥
          # ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ì¤€ë¹„
          
      - name: ë¡¤ë°± ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "âš ï¸ ë°°í¬ ì‹¤íŒ¨ë¡œ ì¸í•œ ë¡¤ë°±ì´ í•„ìš”í•©ë‹ˆë‹¤.",
              "attachments": [{
                "color": "danger",
                "fields": [{
                  "title": "ì‹¤íŒ¨í•œ Job",
                  "value": "ë°°í¬ ê³¼ì •ì—ì„œ ì˜¤ë¥˜ ë°œìƒ",
                  "short": false
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}